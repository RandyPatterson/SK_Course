@model Chat.Models.ChatModel
@{
	ViewData["Title"] = "Semantic Kernel Chat";
}

<link rel="stylesheet" href="~/css/chat.css" asp-append-version="true" />
<style>
	@Html.Raw(ViewData["CustomCSS"])
</style>

<div class="text-center">
	<h1 class="display-5 fw-light">@ViewData["Title"]</h1>
</div>

<form id="chatForm" method="post">
	<div id="chatHistory" style="height: 65vh" class="history container border shadow rounded m-2 p-2">
		@await Html.PartialAsync("ChatHistoryPartialView", Model)
	</div>

	<div style="height: 15vh" class="container-fluid ">
		<div class="row">
			<label class="mt-3 form-label" asp-for="Prompt"></label>
		</div>
		<div class="row">
			<div class="col-11">
				<textarea id="promptInput" class="form-control" placeholder="Press ctrl+enter to submit prompt" asp-for="@Model.Prompt" rows="3"></textarea>
			</div>
			<div class="col-1">
				<input type="button" value="Submit" class="btn btn-primary" onclick="submitChatForm()" />
			</div>
		</div>
	</div>
</form>

<div class="no-drop-indicator"></div>

@section Scripts {
	<script>
		function submitChatForm() {
			//Make sure there is some text before submitting
			let promptInput = $('#promptInput').val().trim();
			if (promptInput === "") {
				$('#promptInput').focus();
				return;
			}

			document.getElementById('chatHistory').innerHTML += `
				<div class="d-flex flex-row-reverse  m-1 User">
				<img class="mb-1" src="images/user_icon.png" />
				</div>
				<div class="d-flex flex-row-reverse m-1 text-primary fw-bold User">
				<pre style="max-width: 75%;">
				`+promptInput+`</pre></div>`

			formData = $('#chatForm').serialize();
			$('#promptInput').val('');
			var interval = addThenRotateImage();
			scrollToBottom();

			$.post({
				url: '@Url.Action("Chat", "Home")',
				data: formData,
				success: function(response) {
					$('#chatHistory').html(response);
					setTimeout(scrollToBottom,100);
					$('#promptInput').focus();
				},
				error: function(xhr, status, error) {
					clearInterval(imageRotation);
					let img = document.getElementById(imageId);
					if (img) {
						img.parentNode.removeChild(img);
					}
					$('#promptInput').focus();
				}
			}).always(function() {
				clearInterval(interval);
			});
		}

		function scrollToBottom() {
			let chat_box = document.getElementById('chatHistory');
			chat_box.scrollTop = chat_box.scrollHeight;
		}

		function addThenRotateImage() {
			let messageContainer = document.getElementById('chatHistory');
			imageId = Math.random().toString(36).substring(2, 10);
			messageContainer.innerHTML += `<div class="p-2"><img id="${imageId}" src="images/ai_icon.png"/></div>`;
			var interval = setInterval(function () {
					rotateImage(imageId);
				}, 100);
			return interval;
		}

		function rotateImage(imageId) {
			var img = document.getElementById(imageId);
			if(img) {
				let rotation = parseInt(img.style.transform.replace(/[^0-9]/g, '')) || 0;
				rotation = (rotation + 10) % 360;
				img.style.transform = 'rotate(' + rotation + 'deg)';
			}
		}

		function handleDrop(e) {
			e.preventDefault();
			e.stopPropagation();
			hideNoDropIndicator();

			const files = e.dataTransfer.files;
			if (files.length > 0) {
				uploadFile(files[0]);
			}
		}

		function uploadFile(file) {
			const formData = new FormData();
			formData.append('file', file);

			$.ajax({
				url: '@Url.Action("UploadFile", "Home")',
				type: 'POST',
				data: formData,
				processData: false,
				contentType: false,
				success: function(response) {
					if (response.success) {
						const fileName = response.fileName;
						$('#promptInput').val(`Uploaded file: ${fileName}`);
						submitChatForm();
					} else {
						alert('Error uploading file: ' + response.message);
					}
				},
				error: function(xhr, status, error) {
					alert('Error uploading file');
				}
			});
		}

		function updateNoDropIndicator(e) {
			const indicator = document.querySelector('.no-drop-indicator');
			indicator.style.display = 'block';
			indicator.style.left = (e.clientX - 16) + 'px';
			indicator.style.top = (e.clientY - 16) + 'px';
		}

		function hideNoDropIndicator() {
			const indicator = document.querySelector('.no-drop-indicator');
			indicator.style.display = 'none';
		}

		$(document).ready(function() {
			$('#promptInput').focus();
			
			$('#promptInput').keydown(function(event) {
				if (event.ctrlKey && event.key === 'Enter') {
					submitChatForm();
				}
			});

			// Handle file drag events on document
			$(document).on('dragover', function(e) {
				e.preventDefault();
				e.stopPropagation();
				updateNoDropIndicator(e);
			});

			$(document).on('dragleave', function(e) {
				e.preventDefault();
				e.stopPropagation();
				// Only hide if we're not entering another element
				if (!e.relatedTarget) {
					hideNoDropIndicator();
				}
			});

			$(document).on('drop', function(e) {
				e.preventDefault();
				e.stopPropagation();
				hideNoDropIndicator();
			});

			// Handle drag events on promptInput
			const promptInput = document.getElementById('promptInput');
			promptInput.addEventListener('dragover', function(e) {
				e.preventDefault();
				e.stopPropagation();
				hideNoDropIndicator();
				$(this).addClass('drag-over');
			});

			promptInput.addEventListener('dragleave', function(e) {
				e.preventDefault();
				e.stopPropagation();
				$(this).removeClass('drag-over');
				// Show no-drop indicator again when leaving textarea
				updateNoDropIndicator(e);
			});

			promptInput.addEventListener('drop', handleDrop);
		});
	</script>
}

